name: Deploy to GitHub Pages
on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
steps:
  - uses: actions/checkout@v4
  - uses: actions/setup-node@v4
    with:
      node-version: 20
      cache: "npm"
      cache-dependency-path: web/package-lock.json
  - run: npm ci
  - run: npm run build
  - run: cp dist/index.html dist/404.html # SPA fallback
  - uses: peaceiris/actions-gh-pages@v3
    with:
      github_token: ${{ secrets.GITHUB_TOKEN }}
      publish_branch: gh-pages
      publish_dir: web/dist
      force_orphan: true

  - name: Install deps
    run: npm ci
    working-directory: web

  - name: Build
    run: npm run build
    working-directory: web

  - name: SPA fallback
    run: cp dist/index.html dist/404.html || copy dist\\index.html dist\\404.html
    working-directory: web

  - name: Deploy to gh-pages
    uses: peaceiris/actions-gh-pages@v3
    with:
      github_token: ${{ secrets.GITHUB_TOKEN }}
      publish_branch: gh-pages
      publish_dir: web/dist
