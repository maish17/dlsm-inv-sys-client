{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "title": "Event Envelope",
    "description": "Common envelope for all ingress events.",
    "type": "object",
    "additionalProperties": false,
    "properties": {
      "eventId":    { "$ref": "../defs/common.json#/$defs/uuidV7" },
      "eventKey":   { "type": "string", "description": "Idempotency key. Recommend deviceCode:epochMs:seq.", "pattern": "^[A-Z0-9-]{3,40}:[0-9]{13}:[0-9]{1,6}$" },
      "producedAt": { "$ref": "../defs/common.json#/$defs/timestamp" },
      "deviceCode": { "$ref": "../defs/common.json#/$defs/deviceCode" },
      "actorId":    { "$ref": "../defs/common.json#/$defs/uuidV7" },
      "kind":       { "$ref": "../defs/common.json#/$defs/EventKind" },
      "payload":    { "type": "object" }
    },
    "required": ["eventId", "producedAt", "kind", "payload"],
    "allOf": [
      {
        "if":   { "properties": { "kind": { "const": "BIND" } }, "required": ["kind"] },
        "then": { "properties": { "payload": { "$ref": "./bind.json" } } } 
      },
      {
        "if":   { "properties": { "kind": { "const": "UNBIND" } }, "required": ["kind"] },
        "then": { "properties": { "payload": { "$ref": "./unbind.json" } } }
      },
      {
        "if":   { "properties": { "kind": { "const": "CHECKIN" } }, "required": ["kind"] },
        "then": { "properties": { "payload": { "$ref": "./checkin.json" } } }
      },
      {
        "if":   { "properties": { "kind": { "const": "CHECKOUT" } }, "required": ["kind"] },
        "then": { "properties": { "payload": { "$ref": "./checkout.json" } } }
      },
      {
        "if":   { "properties": { "kind": { "const": "RETURN" } }, "required": ["kind"] },
        "then": { "properties": { "payload": { "$ref": "./return.json" } } }
      },
      {
        "if":   { "properties": { "kind": { "const": "MOVE" } }, "required": ["kind"] },
        "then": { "properties": { "payload": { "$ref": "./move.json" } } }
      }
    ],
    "examples": [
      {
        "eventId": "018f1b3c-9c8a-7a1b-b2c3-4d5e6f708111",
        "eventKey": "KIOSK-01:1736200000000:42",
        "producedAt": "2025-09-09T16:00:00Z",
        "deviceCode": "KIOSK-01",
        "kind": "CHECKIN",
        "payload": { "objectType": "ITEM", "objectId": "018f1b3c-...", "zoneId": "018f1b3c-...", "ctbPath": [] }
      }
    ]
  }